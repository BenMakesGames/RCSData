{% extends 'RCSDataBundle::base.html.twig' %}

{% block additionalScripts %}
    <script src="/js/d3.v3.min.js"></script>
    <script>
        var chart;

        $(function() {
            $('#filters').submit(function(e) {
                e.preventDefault();

                var search = {
                    plot: $('#filter_plot').val(),
                    resolution: $('#filter_resolution').val()
                };

                $.getJSON('{{ path('report_data') }}', search, function(response) {
                    $('#report-graph').empty();

                    var width = $('#report-graph').width();
                    var height = 300;

                    chart = d3.select('#report-graph').append('svg')
                        .attr('class', 'chart')
                        .attr('width', width)
                        .attr('height', height)
                    ;

                    var maxY = undefined;
                    var minY = undefined;

                    $.each(response.data, function(x, y) {
                        minY = (minY === undefined) ? y.value : Math.min(minY, y.value);
                        maxY = (maxY === undefined) ? y.value : Math.max(maxY, y.value);
                    });

                    if(minY == maxY) minY = 0;

                    var yScale = d3.scale.linear()
                        .domain([minY, maxY])
                        .range([20, 280]) // 20px padding on top and bottom (room for yTick and xTick labels)
                    ;

                    var xScale = d3.scale.linear()
                        .domain([0, response.data.length - 1])
                        .range([50, width - 20]) // 50px padding on the left (room for yTick labels); 20px on the right (for xTick labels)
                    ;

                    chart.selectAll('line.yTick')
                        .data(yScale.ticks(10))
                    .enter().append('line')
                        .attr('class', 'yTick')
                        .attr('x1', 0)
                        .attr('x2', width)
                        .attr('y1', function(d) { return height - yScale(d); })
                        .attr('y2', function(d) { return height - yScale(d); })
                        .style('stroke', '#ccc')
                    ;

                    chart.selectAll('text.yTick')
                        .data(yScale.ticks(10))
                    .enter().append('text')
                        .attr('class', 'yTick')
                        .attr('x', 0)
                        .attr('y', function(d) { return height - yScale(d); })
                        .attr('dy', -3)
                        .attr('text-anchor', 'right')
                        .attr('fill', '#666')
                        .attr('font-size', '12')
                        .text(String)
                    ;

                    chart.selectAll('line.xTick')
                        .data(xScale.ticks(response.data.length))
                    .enter().append('line')
                        .attr('class', 'xTick')
                        .attr('x1', function(d) { return xScale(d); })
                        .attr('y1', 0)
                        .attr('x2', function(d) { return xScale(d); })
                        .attr('y2', height)
                        .style('stroke', '#ccc')
                    ;

                    chart.selectAll('text.xTick')
                        .data(xScale.ticks(response.data.length))
                    .enter().append('text')
                        .attr('class', 'xTick')
                        .attr('x', function(d) { xScale(d) })
                        .attr('y', height)
                        .attr('fill', '#666')
                        .attr('font-size', 12)
                        .text(String)
                    ;

                    var line = d3.svg.line()
                        .x(function(d, i) { return xScale(i); })
                        .y(function(d) { return height - yScale(d.value); })
                    ;

                    chart.append('svg:path')
                        .attr('d', line(response.data))
                        .attr('fill', 'none')
                        .attr('stroke-width', 2)
                        .attr('stroke', 'steelblue')
                    ;
/*
                    chart.selectAll('rect')
                        .data(response.data)
                    .enter().append('rect')
                        .attr('fill', '#369')
                        .attr('x', function(d, i) { return xScale(i); } )
                        .attr('y', function(d, i) { return height - (yScale(d.value) < 0 ? 0 : yScale(d.value)) - yScale(0); })
                        .attr('width', function(d, i) { return xScale.rangeBand(i); })
                        .attr('height', function(d, i) { return Math.abs(yScale(d.value)); })
                    ;
*/
                });
            });
        });
    </script>
{% endblock %}

{% block content %}
    <h1>Graph</h1>
    <form id="filters" class="search-form">
        <div>
            <label for="filter_plot">Data</label>
            <select name="plot" id="filter_plot">
                <option value="turbidityNtu">Average Turbidity (NTU)</option>
                <option value="temperatureC">Average Water Temperature (&deg;C)</option>
                <option value="dissolvedOxygenPpm">Average Dissolved Oxygen (ppm)</option>
                <option value="ph">Average pH</option>
                <option value="airTemperatureC">Average Air Temperature (&deg;C)</option>
            </select>
        </div>
        <div>
            <label for="filter_resolution">Resolution</label>
            <select name="resolution" id="filter_resolution">
                <option value="day">Day</option>
                <option value="month">Month</option>
                <option value="year">Year</option>
            </select>
        </div>
        <input type="submit" class="button" value="Plot" />
    </form>
    <div id="report-graph" style="height:300px;">
    </div>
{% endblock %}